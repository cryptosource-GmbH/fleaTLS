

AS      = $(GCC_BIN)arm-none-eabi-as
CC      = $(GCC_BIN)arm-none-eabi-gcc
CPP     = $(GCC_BIN)arm-none-eabi-g++
LD      = $(GCC_BIN)arm-none-eabi-gcc
OBJCOPY = $(GCC_BIN)arm-none-eabi-objcopy
OBJDUMP = $(GCC_BIN)arm-none-eabi-objdump
SIZE    = $(GCC_BIN)arm-none-eabi-size 
###################################################

# Check for valid float argument
ifneq ($(FLOAT_TYPE), hard)
ifneq ($(FLOAT_TYPE), soft)
#override FLOAT_TYPE = hard
override FLOAT_TYPE = soft
endif
endif

###################################################

INCLUDES = -Iinclude -Iinclude/api -Itest/include

vpath %.c src/common src/common/math src/common/hash src/common/hash src/common/pk_enc src/user

CFLAGS  = -O3 -g -Wall -std=c99

#-g 
CFLAGS += $(INCLUDES) -DFLEA_PLTF_ARM_32BIT

CFLAGS += -mthumb -mcpu=cortex-m3

# allow discarding of unused code during linking:
CFLAGS += -fdata-sections -ffunction-sections

ifeq ($(FLOAT_TYPE), hard)
CFLAGS += -fsingle-precision-constant -Wdouble-promotion
CFLAGS += -mfpu=fpv4-sp-d16 -mfloat-abi=hard
#CFLAGS += -mfpu=fpv4-sp-d16 -mfloat-abi=softfp
else
CFLAGS += -msoft-float
endif

#CFLAGS += -ffreestanding -nostdlib -MMD -MP
CFLAGS += -MMD -MP
CFLAGS += -Iinc -Iinc/core -Iinc/peripherals

LD_FLAGS =-Wl,--gc-sections -mcpu=cortex-m3 -mthumb 
LD_SYS_LIBS = -lstdc++ -lsupc++ -lm -lc -lgcc -lnosys

SRC_DIR = src

SRC_DIRS = src/common/asn1 src/common/streams src/common src/common/hash src/common/math src/common/pk_enc src/user


SRCS := $(foreach dir,$(SRC_DIRS),$(wildcard $(dir)/*.c))
#$(info $$SRCS is [${SRCS}])

OBJDIR = build/lpc1768
OBJS_RAW = $(SRCS:.c=.o)

OBJS = $(addprefix $(OBJDIR)/, $(OBJS_RAW))

DEPS_RAW = $(SRCS:.c=.d)

DEPS = $(addprefix $(OBJDIR)/, $(DEPS_RAW))


	
.PHONY: libflea_lpc1768.a

all: libflea_lpc1768.a test

# $< = "prerequisite": right hand side in target def
# $@ = left hand side of the target def

$(OBJDIR)/%.o : %.c
	$(CC) $(CFLAGS) -c $< -o $@ 
  
libflea_lpc1768.a: $(OBJS)
	$(AR) -r $@ $(OBJS)

test: libflea_lpc1768.a
	@echo "making test"
	$(MAKE) -C test FLOAT_TYPE=$(FLOAT_TYPE)

clean:
	find $(OBJDIR) -name "*.d" | xargs -n1 trash-put
	rm -f $(OBJS)  libflea_lpc1768.a 
	$(MAKE) clean -C test

-include $(DEPS)

